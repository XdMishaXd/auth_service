{
    "swagger": "2.0",
    "info": {
        "description": "Сервис авторизации",
        "title": "Auth Service API",
        "contact": {},
        "version": "1.0"
    },
    "host": "localhost:8082",
    "basePath": "/",
    "paths": {
        "/auth/login": {
            "post": {
                "description": "## Описание\nВыполняет аутентификацию пользователя по email и паролю, возвращает пару токенов (access и refresh).\n\n### Процесс аутентификации:\n1. Валидация входных данных (email формат, наличие пароля)\n2. Проверка существования пользователя в базе данных\n3. Верификация пароля (bcrypt hash comparison)\n4. Проверка статуса email (должен быть подтвержден)\n5. Валидация app_id (приложение должно существовать)\n6. Генерация JWT токенов (access и refresh)\n\n### Токены:\n- **Access Token**: JWT токен для доступа к защищенным ресурсам (TTL: 15 минут)\n- **Refresh Token**: JWT токен для обновления access токена (TTL: 30 дней)\n\n### Коды ошибок:\n- `400` - Некорректные данные (невалидный email, отсутствие полей)\n- `401` - Неверные credentials (пароль не совпадает)\n- `403` - Email не подтвержден\n- `404` - Пользователь или приложение не найдены\n- `500` - Внутренняя ошибка сервера",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Аутентификация пользователя",
                "parameters": [
                    {
                        "description": "Данные для входа",
                        "name": "credentials",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "type": "object",
                            "properties": {
                                "app_id": {
                                    "type": "integer"
                                },
                                "email": {
                                    "type": "string"
                                },
                                "password": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Успешная аутентификация\"  example({\"status\": \"ok\", \"access_token\": \"eyJhbGc...\", \"refresh_token\": \"eyJhbGc...\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "access_token": {
                                    "type": "string"
                                },
                                "refresh_token": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Ошибка валидации\"  example({\"status\": \"error\", \"error\": \"Invalid email format\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Неверные credentials\"  example({\"status\": \"error\", \"error\": \"Invalid credentials\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "403": {
                        "description": "Email не подтвержден\"  example({\"status\": \"error\", \"error\": \"Email is not verified\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Пользователь не найден\"  example({\"status\": \"error\", \"error\": \"User not found\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка\"  example({\"status\": \"error\", \"error\": \"Internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 1
            }
        },
        "/auth/logout": {
            "post": {
                "description": "## Описание\nЗавершает активную сессию пользователя, инвалидируя refresh токен.\n\n### Процесс выхода:\n1. Валидация refresh токена из тела запроса\n2. Проверка существования токена в базе данных\n3. Добавление токена в blacklist (Redis)\n4. Удаление токена из таблицы активных сессий\n5. Инвалидация связанного access токена\n\n### Особенности:\n- После logout refresh токен больше нельзя использовать для получения новых access токенов\n- Access токен технически остается валидным до истечения TTL (~15 минут)\n- Для немедленной инвалидации access токена используется blacklist в Redis\n- Поддержка \"logout from all devices\" (опционально)\n\n### Безопасность:\n- Токен в blacklist хранится только до истечения его TTL\n- При попытке использовать инвалидированный токен возвращается 401\n- Логирование всех операций logout для аудита",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Выход из системы",
                "parameters": [
                    {
                        "description": "Refresh токен для инвалидации",
                        "name": "token",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "type": "object",
                            "properties": {
                                "refresh_token": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Успешный выход из системы\"  example({\"status\": \"ok\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Ошибка валидации: токен не передан или некорректный JSON\"  example({\"status\": \"error\", \"error\": \"refresh_token is required\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Невалидный или истекший refresh токен\"  example({\"status\": \"error\", \"error\": \"Invalid credentials\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка сервера\"  example({\"status\": \"error\", \"error\": \"Internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 4
            }
        },
        "/auth/refresh": {
            "post": {
                "description": "## Описание\nОбменивает действующий refresh токен на новую пару токенов (access и refresh).\n\n### Процесс обновления:\n1. Валидация refresh токена (подпись JWT, срок действия)\n2. Извлечение user_id и app_id из payload токена\n3. Проверка что токен не находится в blacklist (Redis)\n4. Проверка статуса пользователя (не заблокирован, email подтвержден)\n5. Генерация новой пары токенов:\n- Новый access токен (TTL: 15 минут)\n- Новый refresh токен (TTL: 30 дней)\n6. Инвалидация старого refresh токена (token rotation)\n7. Сохранение нового refresh токена в БД\n\n### Token Rotation (безопасность):\n- **Каждый refresh токен одноразовый** — после использования старый токен инвалидируется\n- Это защищает от атак с украденными токенами\n- При попытке использовать старый токен — все сессии пользователя инвалидируются\n\n### Время жизни токенов:\n- **Access Token**: 15 минут (короткий для безопасности)\n- **Refresh Token**: 30 дней (удобство для пользователя)\n- Если пользователь неактивен 30 дней — требуется повторный login\n\n### Когда использовать:\n- Access токен истек (получили 401 на защищенном endpoint)\n- Превентивное обновление перед истечением access токена\n- После длительного простоя приложения\n\n### Ошибки:\n- `400`: Невалидный JSON или отсутствует refresh_token\n- `401`: Токен истек, невалиден или уже использован\n- `403`: Пользователь заблокирован\n- `500`: Ошибка БД или генерации токенов",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Обновление access токена",
                "parameters": [
                    {
                        "description": "Текущий refresh токен",
                        "name": "token",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "type": "object",
                            "properties": {
                                "refresh_token": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Новая пара токенов\"  example({\"status\": \"ok\", \"access_token\": \"eyJhbGc...\", \"refresh_token\": \"eyJhbGc...\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "access_token": {
                                    "type": "string"
                                },
                                "refresh_token": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Ошибка валидации\"  example({\"status\": \"error\", \"error\": \"refresh_token is required\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Невалидный или истекший токен\"  example({\"status\": \"error\", \"error\": \"Invalid credentials\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка\"  example({\"status\": \"error\", \"error\": \"Internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 3
            }
        },
        "/auth/register": {
            "post": {
                "description": "## Описание\nСоздает новую учетную запись пользователя в системе и отправляет письмо с подтверждением email.\n\n### Процесс регистрации:\n1. Валидация входных данных (email формат, наличие username и пароля)\n2. Проверка уникальности email и username в базе данных\n3. Хеширование пароля с использованием bcrypt (cost factor 12)\n4. Создание записи пользователя в БД со статусом `email_verified = false`\n5. Генерация JWT токена верификации (валиден 24 часа)\n6. Отправка email с ссылкой подтверждения через RabbitMQ\n\n### Требования к данным:\n- **Email**: Валидный email формат (example@domain.com), должен быть уникальным\n- **Username**: Минимум 3 символа, только буквы, цифры и подчеркивание, должен быть уникальным\n- **Password**: Минимум 8 символов, рекомендуется использовать заглавные буквы, цифры и спецсимволы\n\n### Email верификация:\n- Письмо отправляется асинхронно через RabbitMQ (не блокирует ответ)\n- Токен верификации действует 24 часа\n- До подтверждения email пользователь не может войти в систему\n- Неподтвержденные аккаунты автоматически удаляются через 7 дней\n\n### Формат ссылки верификации:\n`http://domain.com/auth/verify?token=eyJhbGc...`",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Регистрация нового пользователя",
                "parameters": [
                    {
                        "description": "Данные нового пользователя",
                        "name": "user",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "type": "object",
                            "properties": {
                                "email": {
                                    "type": "string"
                                },
                                "password": {
                                    "type": "string"
                                },
                                "username": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                ],
                "responses": {
                    "201": {
                        "description": "Пользователь успешно создан, письмо отправлено\"  example({\"status\": \"ok\", \"user_id\": 42})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "status": {
                                    "type": "string"
                                },
                                "user_id": {
                                    "type": "integer"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Ошибка валидации: некорректный email, слишком короткий пароль или отсутствуют обязательные поля\"  example({\"status\": \"error\", \"error\": \"Email must be a valid email address\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "409": {
                        "description": "Пользователь с таким email или username уже существует\"  example({\"status\": \"error\", \"error\": \"User with this email already exists\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка: проблемы с БД, RabbitMQ или email сервисом\"  example({\"status\": \"error\", \"error\": \"Internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 2
            }
        },
        "/auth/verify": {
            "get": {
                "description": "## Описание\nПодтверждает email адрес пользователя по токену из письма, активируя учетную запись.\n\n### Процесс верификации:\n1. Извлечение токена из query параметра `token`\n2. Валидация JWT токена (подпись, срок действия)\n3. Извлечение user_id из payload токена\n4. Проверка что пользователь существует и email еще не подтвержден\n5. Обновление статуса `email_verified = true` в базе данных\n6. Инвалидация токена (предотвращение повторного использования)\n\n### Особенности токена:\n- **Срок действия**: 24 часа с момента регистрации\n- **Формат**: JWT (JSON Web Token) подписанный HMAC-SHA256\n- **Одноразовый**: После успешной верификации токен инвалидируется\n- **Payload**: Содержит `user_id` и `exp` (время истечения)\n\n### После подтверждения:\n- Пользователь может войти в систему через `/auth/login`\n- Email помечен как подтвержденный навсегда\n- Опционально: отправка welcome email\n\n### Ошибки:\n- `400`: Токен отсутствует в URL\n- `401`: Токен невалидный, истек или уже использован\n- `500`: Ошибка базы данных",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Подтверждение email адреса",
                "parameters": [
                    {
                        "type": "string",
                        "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo0MiwiZXhwIjoxNzA2MTIzNDU2fQ.signature",
                        "description": "JWT токен верификации из email",
                        "name": "token",
                        "in": "query",
                        "required": true
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Email успешно подтвержден, можно входить в систему\"  example({\"status\": \"ok\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Токен отсутствует в URL\"  example({\"status\": \"error\", \"error\": \"missing token\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Токен невалидный, истек или уже использован\"  example({\"status\": \"error\", \"error\": \"invalid or expired token\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка сервера\"  example({\"status\": \"error\", \"error\": \"internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 5
            }
        },
        "/auth/verify/resend": {
            "post": {
                "description": "## Описание\nПовторно отправляет письмо с подтверждением email адреса пользователю.\n\n### Процесс отправки:\n1. Валидация email формата\n2. Проверка существования пользователя с указанным email\n3. Проверка статуса верификации email\n4. Если email не подтвержден - генерация нового токена верификации\n5. Отправка письма через RabbitMQ\n6. Возврат успешного ответа (независимо от статуса верификации)\n\n### Когда использовать:\n- Пользователь не получил первое письмо\n- Токен верификации истек (24 часа)\n- Письмо попало в спам\n- Пользователь случайно удалил письмо\n\n### Безопасность (важно!):\n- Endpoint всегда возвращает 200 OK, даже если email уже подтвержден\n- Это предотвращает enumeration атаки (определение существующих email)\n- Не раскрывает информацию о существовании пользователя\n- Rate limiting должен быть настроен (максимум 3 запроса в час на email)\n\n### Особенности:\n- Если email уже подтвержден - письмо не отправляется (но ответ 200 OK)\n- Новый токен инвалидирует предыдущий\n- Токен действителен 24 часа\n- Отправка асинхронная через RabbitMQ (не блокирует ответ)\n",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "auth"
                ],
                "summary": "Повторная отправка письма верификации",
                "parameters": [
                    {
                        "description": "Email пользователя",
                        "name": "email",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "type": "object",
                            "properties": {
                                "email": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Письмо отправлено (или email уже подтвержден)\"  example({\"status\": \"ok\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Ошибка валидации: некорректный email формат\"  example({\"status\": \"error\", \"error\": \"Email must be a valid email address\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Пользователь не найден\"  example({\"status\": \"error\", \"error\": \"User not found\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    },
                    "500": {
                        "description": "Внутренняя ошибка сервера\"  example({\"status\": \"error\", \"error\": \"Internal error\"})",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                },
                "x-order": 6
            }
        }
    }
}